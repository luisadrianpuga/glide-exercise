# Incident Report: VAL-201 – Email Validation Problems

## Summary
- Reporter: James Wilson  
- Priority: High  
- Description: Signup accepted malformed email addresses (e.g., missing TLD, consecutive dots, `.con` typos). Backend only relied on `z.string().email()` and the frontend regex merely checked for the presence of `@`, so invalid inputs slipped through.

## Impact
- Created unusable customer accounts that could not receive onboarding or compliance emails.
- Increased bounce rates and manual remediation work for support.

## Detection
- Reported via ticket VAL-201 after customers noticed typos like `user@@domain` or `name@example.con` being accepted without error.

## Root Cause
1. The React Hook Form validation used `/^\S+@\S+$/i`, which only enforces `@` and non-whitespace characters.
2. The TRPC signup/login endpoints relied on Zod's basic `email()` validator, which doesn’t catch `.con` or consecutive-dot issues.

## Resolution
- Introduced `lib/validation/email.ts` containing `getEmailValidationError`, which enforces:
  - No consecutive dots or local-part dots at the edges.
  - Domain labels composed of alphanumeric characters/hyphens, not starting/ending with hyphens.
  - Minimum two-character alphabetical TLD and detection of common typos like `.con`.
- Updated the signup form to call this helper via React Hook Form so users get immediate feedback.
- Replaced backend `z.string().email()` usage with an `emailSchema` that leverages the same helper and trims/lowercases the value, ensuring API clients cannot bypass the stricter rules.

## Verification
- Manual reasoning/tests: previously accepted inputs (`user..name@example.com`, `test@example`, `demo@example.con`) now produce descriptive validation errors on both client and server. Valid emails (including plus tags) pass normally.
- Recommended follow-up: add automated unit tests for `getEmailValidationError` and integration tests for the signup/login flows.

## Lessons Learned
1. Share validation logic between frontend and backend to avoid drift.
2. Avoid overly permissive regexes for critical identifiers like email addresses.
3. Include known typo detection (.con, repeated dots) to reduce downstream support load.
