# Incident Report: VAL-210 – Card Type Detection Gaps

## Summary
- Reporter: Support Team  
- Priority: High  
- Description: The funding flow rejected valid cards (e.g., Diners Club, JCB) because validation only looked for Visa/Mastercard/Amex/Discover prefixes. Customers using other major networks couldn’t complete deposits.

## Impact
- Legitimate funding attempts failed, forcing customers to switch cards or contact support.
- Higher churn risk for international users relying on JCB/UnionPay cards.

## Detection
- Support received multiple complaints that specific card brands were labeled “Invalid card number” despite passing the Luhn check.

## Root Cause
1. Both frontend (`FundingModal`) and backend (`accountRouter`) relied on `CARD_PATTERNS` covering only the Big Four networks.
2. The validator returned “Unsupported card type” whenever the prefix didn’t match, even if the number was valid.

## Resolution
- Expanded `CARD_PATTERNS` on both client and server to include additional major issuers (Diners Club, JCB, UnionPay) while retaining the existing Luhn check and length constraints.
- Validation now accepts 13–19 digit numbers across the supported networks.

## Verification
- Manual reasoning/tests: JCB (`3530111333300000`), Diners (`30569309025904`), and UnionPay test numbers now pass validation on both the form and API. Invalid prefixes continue to be rejected.

## Lessons Learned
1. Keep card detection logic centralized and updated with industry reference ranges.
2. Validate against both issuer ranges and Luhn checksum to avoid false positives.
3. Consider a shared utility or third-party library to manage card metadata consistently.
