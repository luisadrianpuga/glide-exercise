# Incident Report: SEC-301 – SSNs Stored in Plaintext

## Summary
- Reporter: Security Audit Team  
- Priority: Critical  
- Description: Social Security Numbers collected during signup were stored directly in the SQLite database with no encryption or masking. User payloads returned from the auth endpoints also included the SSN field.

## Impact
- Severe privacy exposure and non-compliance with regulations (GLBA, SOX, etc.).
- Insider threat: anyone with DB or log access could exfiltrate SSNs.
- API responses exposed SSNs to clients, increasing attack surface.

## Detection
- Security audit flagged plaintext `ssn` column content and verified API responses after user creation/login included the value.

## Root Cause
1. The users table defined `ssn TEXT NOT NULL` but there was no encryption or hashing prior to insertion (`server/routers/auth.ts` simply spread the form input).
2. The signup/login responses returned the entire user row (minus password only), so encrypted or not, SSNs would have been exposed in API responses.

## Resolution
- Added `lib/security/ssn.ts` implementing AES-256-GCM helpers (`encryptSSN`, `decryptSSN`) using an environment-provided `SSN_ENCRYPTION_KEY`.
- Updated `server/routers/auth.ts` to:
  - Encrypt SSNs before inserting a user record.
  - Strip both `password` and `ssn` fields from objects sent back to the client.
- Existing schema remains `TEXT`, but now stores the encrypted blob instead of plaintext.

## Verification
- Manual reasoning/tests: creating a new user now writes an unreadable base64 payload into `users.ssn`. Attempting to read the API response confirms `ssn` is omitted. With a valid key, `decryptSSN` can recover the original value if ever needed for regulated workflows.
- Recommended follow-up: run a migration to encrypt historical SSNs and rotate the encryption key using a secrets manager.

## Lessons Learned
1. Sensitive fields should never be stored or returned in plaintext; enforce encryption at the application boundary.
2. Sanitize API responses by default (least privilege) so newly added columns don’t leak customer data.
3. Include encryption/secret-handling requirements in acceptance criteria for features dealing with PII.
